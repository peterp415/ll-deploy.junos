#jinja2:lstrip_blocks: True
{# Common configuration for all JunOS devices #}
system {
    host-name {{ junos_config_hostname }};
    time-zone {{ junos_location.time_zone }};
    license {
        autoupdate {
        url {{ junos_autoupdate_url }};
        }
    }
    root-authentication {
        encrypted-password "{{ junos_root_auth.encrypted_password }}";
        ssh-rsa "{{ junos_root_auth.ssh_key }}";
    }
    {# Defaults for syslog from Juniper, could be templated if need in future #}
    syslog {
        user * {
            any emergency;
        }
        file messages {
            any any;
            authorization info;
        }
        file interactive-commands {
            interactive-commands any;
        }
    }
    services {
        ssh {
            {% if junos_ssh_root_login|capitalize == 'True' %}
            root-login allow;
            {% else %}
            root-login deny;
            {% endif %}
        }
        netconf {
            ssh;
        }
    }
    {% if junos_users is defined %}
    login {
        {% for user in junos_users %}
        user {{ user.name }} {
            uid {{ user.uid }};
            class {{ user.class }};
            authentication {
                ssh-rsa "{{ user.ssh_key }}";
            }
        }
        {% endfor %}
    }
    {% endif %}
}

{# Common security #}
security {
    screen {
        ids-option untrust-screen {
            icmp {
                ping-death;
            }
            ip {
                source-route-option;
                tear-drop;
            }
            tcp {
                syn-flood {
                    alarm-threshold 1024;
                    attack-threshold 200;
                    source-threshold 1024;
                    destination-threshold 2048;
                    queue-size 2000; ## Warning: 'queue-size' is deprecated
                    timeout 20;
                }
                land;
            }
        }
    }
    zones {
        functional-zone management {
        }
        security-zone trust {
            tcp-rst;
        }
        security-zone untrust {
            screen untrust-screen;
        }
    }
}

{# BGP #}
{% if junos_bgp_groups is defined %}
protocols {
    bgp {
        {% for group in junos_bgp_groups %}
        group {{ group.name }} {
            type {{ group.type }};
            local-as {{ group.local_asn }};
            {% if group.export_policy is defined %}
            export {{ group.export_policy }};
            {% endif %}
            {% for neighbor in group.neighbors %}
            neighbor {{ neighbor.address }} {
                peer-as {{ neighbor.asn }};
            }
            {% endfor %}
        }
        {% endfor %}
    }
}
{% endif %}

{# Policy Options #}
{% if junos_policy_options is defined %}
policy-options {
    {% for policy in junos_policy_options.policies %}
    policy-statement {{ policy.name }} {
        {% for term in policy.terms %}
        term {{ term.name }} {
            from {
                {% if term.protocol is defined %}
                protocol {{ term.protocol }};
                {% endif %}
                {% if term.route_filter is defined %}
                route-filter {{ term.route_filter }};
                {% endif %}
            }
            then {{ term.action }};
        }
        {% endfor %}
        {% if policy.community is defined or policy.as_path_prepend is defined %}
        then {
            {% if policy.community is defined %}
            community set {{ policy.community }};
            {% elif policy.as_path_prepend is defined %}
            as-path-prepend "{{ policy.as_path_prepend }}";
            {% endif %}
            {{ policy.action }};
        }
        {% else %}
        then {{ policy.action }};
        {% endif %}
    }
    {% endfor %}
    {% if junos_policy_options.communities is defined %}
    {% for community in junos_policy_options.communities %}
    community {{ community.name }} members {{ community.members }};
    {% endfor %}
    {% endif %}
}
{% endif %}
